(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{80:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return s})),n.d(t,"metadata",(function(){return o})),n.d(t,"rightToc",(function(){return i})),n.d(t,"default",(function(){return b}));var a=n(3),r=n(7),c=(n(0),n(90)),s={title:"Multi-Tenancy"},o={unversionedId:"advanced/multi-tenancy",id:"advanced/multi-tenancy",isDocsHomePage:!1,title:"Multi-Tenancy",description:"Best Practices for Multi-Tenancy",source:"@site/docs/advanced/multi-tenancy.md",slug:"/advanced/multi-tenancy",permalink:"/k8s-notes/advanced/multi-tenancy",editUrl:"https://github.com/jasonk/k8s-notes/edit/main/docs/advanced/multi-tenancy.md",version:"current"},i=[{value:"Personas",id:"personas",children:[]},{value:"Namespaces",id:"namespaces",children:[]},{value:"RBAC Only",id:"rbac-only",children:[]},{value:"Network Policy",id:"network-policy",children:[]},{value:"Limit Tenant Access",id:"limit-tenant-access",children:[]},{value:"Restrict HostPath Volumes",id:"restrict-hostpath-volumes",children:[]},{value:"Validation Testing",id:"validation-testing",children:[]},{value:"Admission Controllers",id:"admission-controllers",children:[]},{value:"Application-Specific Multi-Tenancy",id:"application-specific-multi-tenancy",children:[{value:"ArgoCD",id:"argocd",children:[]}]},{value:"Further Reading",id:"further-reading",children:[]}],l={rightToc:i};function b(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(c.b)("wrapper",Object(a.a)({},l,n,{components:t,mdxType:"MDXLayout"}),Object(c.b)("blockquote",null,Object(c.b)("p",{parentName:"blockquote"},"Best Practices for Multi-Tenancy")),Object(c.b)("p",null,"Most of these are recommendations for the ",Object(c.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/kubernetes-sigs/multi-tenancy"}),"Kubernetes Working Group\nfor Multi-Tenancy"),"."),Object(c.b)("h3",{id:"personas"},"Personas"),Object(c.b)("p",null,"The multi-tenancy SIG recommends four personas scoped to limit their permissions:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("strong",{parentName:"li"},"Cluster Admin")," - Read and write access to all resources in the cluster (including tenant resources)."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("strong",{parentName:"li"},"Cluster View")," - Read-only access to all resources in the cluster (including tenant resources)."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("strong",{parentName:"li"},"Tenant Admin")," - Read and write access scoped to a specific tenant.  Can create, update, delete tenant users within that tenant. No access to resources scoped to other tenants."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("strong",{parentName:"li"},"Tenant User")," - Read and write access to all resources scoped to their tenant.")),Object(c.b)("h3",{id:"namespaces"},"Namespaces"),Object(c.b)("p",null,"Three top-level groups of namespaces are recommended:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("strong",{parentName:"li"},"System Namespaces")," - Used only for system pods (like ",Object(c.b)("inlineCode",{parentName:"li"},"kube-system"),", for example)."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("strong",{parentName:"li"},"Service Namespaces")," - Used to run services or applications that need to be accessed by services in other namespaces.  Created by a cluster-admin to run services of applications that have network reachability to or from other namespaces in the cluster as needed to deliver a common service (for example, shared load balancing service)."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("strong",{parentName:"li"},"Tenant Namespaces")," - Tenant Namespaces should be use to run applications that do not need to be accessed from other namespaces in the cluster.  These are created by a Tenant Admin to run end-user applications and do not have network reachability to or from other Tenant namespaces by default (though they can be modified to provide that access if needed).")),Object(c.b)("h3",{id:"rbac-only"},"RBAC Only"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"Role Based Access Control (RBAC) should be enabled."),Object(c.b)("li",{parentName:"ul"},"Attribute Based Access Control (ABAC) should be disabled.")),Object(c.b)("h3",{id:"network-policy"},"Network Policy"),Object(c.b)("p",null,"A network policy that isolates tenants from each other should be applied.\n",Object(c.b)("a",Object(a.a)({parentName:"p"},{href:"https://raw.githubusercontent.com/kubernetes/website/master/content/en/examples/policy/restricted-psp.yaml"}),"Sample Policy")),Object(c.b)("h3",{id:"limit-tenant-access"},"Limit Tenant Access"),Object(c.b)("p",null,"Cluster admins should ensure that tenants do not have access to view, edit, create, or delete cluster-scoped resources (those without namespaces, such as ",Object(c.b)("inlineCode",{parentName:"p"},"Node"),", ",Object(c.b)("inlineCode",{parentName:"p"},"ClusterRole"),", ",Object(c.b)("inlineCode",{parentName:"p"},"ClusterRoleBinding"),")."),Object(c.b)("p",null,"To see a list of non-namespaced resources:"),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sh"}),"kubectl --kubeconfig cluster-admin api-resources --namespaced=false\n")),Object(c.b)("p",null,"To check whether a tenant can perform operations on resources:"),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sh"}),"kubectl --kubeconfig <tenant> auth can-i \u201cverb\u201d \u201cresource\u201d\n")),Object(c.b)("p",null,"To see a list of resources belonging to a tenant:"),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sh"}),"kubectl --kubeconfig <tenant> api-resources --namespaced=true\n")),Object(c.b)("p",null,"To see whether tenants can perform operations on namespaced resources belonging to other tenants:"),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sh"}),"kubectl --kubeconfig <tenant> -n <namespace> <verb> <resource>\n")),Object(c.b)("p",null,"There are some resources in a tenant namespace that should not be accessible to the tenants of that namespace.  These include things like the default network policy, namespace resource quotes and role bindings."),Object(c.b)("p",null,"To see a list of resources managed by cluster-admin in a tenant namespace:"),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sh"}),"kubectl --kubeconfig=cluster-admin -n <namespace> get all -l =\n")),Object(c.b)("p",null,"To confirm that the tenant cannot modify these resources (this requires labelling resources managed by the cluster admin):"),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sh"}),"kubectl --dry-run=true --kubeconfig=<tenant> -n <namespace> annotate k=v\n")),Object(c.b)("h3",{id:"restrict-hostpath-volumes"},"Restrict HostPath Volumes"),Object(c.b)("p",null,Object(c.b)("a",Object(a.a)({parentName:"p"},{href:"https://gist.github.com/abhisek/b9acfdc0505905ffc4240841195326ee"}),"Sample Policy")),Object(c.b)("h3",{id:"validation-testing"},"Validation Testing"),Object(c.b)("p",null,"The multi-tenancy SIG provides an e-2-e test tool that can validate multi-tenant clusters."),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sh"}),"git clone https://github.com/kubernetes-sigs/multi-tenancy.git\ncd multi-tenancy/benchmarks\nvi config.yaml # Update config file with your cluster configuration\ngo test ./e2e/tests\n")),Object(c.b)("h3",{id:"admission-controllers"},"Admission Controllers"),Object(c.b)("p",null,"The multi-tenancy SIG recommends that these admission controllers be enabled:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("inlineCode",{parentName:"li"},"PodSecurityPolicy")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("inlineCode",{parentName:"li"},"AlwaysPullImages")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("inlineCode",{parentName:"li"},"ServiceAccount")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("inlineCode",{parentName:"li"},"ResourceQuota")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("inlineCode",{parentName:"li"},"LimitRanger"))),Object(c.b)("p",null,Object(c.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/kubernetes-sigs/multi-tenancy/blob/master/docs/profiles/profile-soft-multitenancy-s1.md#kubernetes-pod-admission-and-security-policy-definition-for-profile-s1"}),"Sample PodSecurityPolicy")),Object(c.b)("h2",{id:"application-specific-multi-tenancy"},"Application-Specific Multi-Tenancy"),Object(c.b)("h3",{id:"argocd"},"ArgoCD"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/argoproj/argo-cd/blob/master/docs/projects.md"}),"https://github.com/argoproj/argo-cd/blob/master/docs/projects.md")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/argoproj/argo-cd/blob/master/docs/rbac.md"}),"https://github.com/argoproj/argo-cd/blob/master/docs/rbac.md"))),Object(c.b)("h2",{id:"further-reading"},"Further Reading"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/kubernetes-sigs/multi-tenancy/tree/master/benchmarks"}),"Multi-Tenancy Benchmarks")," - guidelines for multi-tenant configuration of Kubernetes clusters."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/kubernetes-sigs/multi-tenancy/blob/master/benchmarks/kubectl-mtb/README.md"}),"kubectl-mtb")," - a kubectl plugin that can validate your cluster agains the Multi-Tenancy Benchmarks."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/kubernetes-sigs/multi-tenancy/tree/master/incubator/hnc"}),"Hierarchical Namespace Controller")," - a controller that allows for hierarchical namespaces, allowing for things like developers creating namespaces under their team namespace without needing cluster-level permission to create namespaces.  See ",Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/kubernetes-sigs/multi-tenancy/blob/master/incubator/hnc/docs/user-guide/quickstart.md"}),"HNC QuickStart")," for some ideas of what you can do with this."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/kubernetes-sigs/multi-tenancy/tree/master/tenant"}),"Tenant Operator")," - an operator that manages a set of CRDs used to manage tenant resources."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"https://kubernetes.io/docs/concepts/policy/resource-quotas/"}),"Resource Quotes"))))}b.isMDXComponent=!0},90:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return d}));var a=n(0),r=n.n(a);function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){c(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},c=Object.keys(e);for(a=0;a<c.length;a++)n=c[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(a=0;a<c.length;a++)n=c[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=r.a.createContext({}),b=function(e){var t=r.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=b(e.components);return r.a.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},m=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,c=e.originalType,s=e.parentName,l=i(e,["components","mdxType","originalType","parentName"]),u=b(n),m=a,d=u["".concat(s,".").concat(m)]||u[m]||p[m]||c;return n?r.a.createElement(d,o(o({ref:t},l),{},{components:n})):r.a.createElement(d,o({ref:t},l))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var c=n.length,s=new Array(c);s[0]=m;var o={};for(var i in t)hasOwnProperty.call(t,i)&&(o[i]=t[i]);o.originalType=e,o.mdxType="string"==typeof e?e:a,s[1]=o;for(var l=2;l<c;l++)s[l]=n[l];return r.a.createElement.apply(null,s)}return r.a.createElement.apply(null,n)}m.displayName="MDXCreateElement"}}]);