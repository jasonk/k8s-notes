<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.68">
<title data-react-helmet="true">MetalLB | Jason&#x27;s Kubernetes Notes</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_language" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="MetalLB | Jason&#x27;s Kubernetes Notes"><meta data-react-helmet="true" name="description" content="An Ingress Controller manages external access to a cluster"><meta data-react-helmet="true" property="og:description" content="An Ingress Controller manages external access to a cluster"><meta data-react-helmet="true" property="og:url" content="https://jasonkohles.com/k8s-notes/setup/metallb"><link data-react-helmet="true" rel="shortcut icon" href="/k8s-notes/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://jasonkohles.com/k8s-notes/setup/metallb"><link rel="stylesheet" href="/k8s-notes/styles.e8739408.css">
<link rel="preload" href="/k8s-notes/styles.69075ca6.js" as="script">
<link rel="preload" href="/k8s-notes/runtime~main.583d16d4.js" as="script">
<link rel="preload" href="/k8s-notes/main.8ee242e7.js" as="script">
<link rel="preload" href="/k8s-notes/1.d74cfc91.js" as="script">
<link rel="preload" href="/k8s-notes/25.575fc837.js" as="script">
<link rel="preload" href="/k8s-notes/935f2afb.ead8358e.js" as="script">
<link rel="preload" href="/k8s-notes/24.e6edf205.js" as="script">
<link rel="preload" href="/k8s-notes/048d1949.98515b4e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_2AhQ">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/k8s-notes/"><strong class="navbar__title">Jason&#x27;s Kubernetes Notes</strong></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/jasonk/k8s-notes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/k8s-notes/"><strong class="navbar__title">Jason&#x27;s Kubernetes Notes</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a href="https://github.com/jasonk/k8s-notes" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive thin-scrollbar menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">About</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/k8s-notes/">Welcome</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/k8s-notes/about/links">Helpful Kubernetes Links</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Setup</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/getting-started">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/control-node">Control Node</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/worker-nodes">Adding Worker Nodes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/user-config">User Configuration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/dashboard">Dashboard</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/helm">Helm</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/operators-and-openebs">Operators and OpenEBS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/jsonnet-and-prometheus">Jsonnet and Prometheus</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/k8s-notes/setup/metallb">MetalLB</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/nginx-ingress">Nginx Ingress</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/exploring-pods">Exploring Pods</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Concepts</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/k8s-notes/concepts/control-plane">Control Plane</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/k8s-notes/concepts/operators">Operators</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/k8s-notes/concepts/tainting">Taints and Tolerations</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Applications</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/k8s-notes/apps/argocd">ArgoCD</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/k8s-notes/apps/cert-manager">cert-manager</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Advanced</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/k8s-notes/advanced/multi-tenancy">Multi-Tenancy Best Practices</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_39qw"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">MetalLB</h1></header><div class="markdown"><p>An <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank" rel="noopener noreferrer">Ingress Controller</a> manages external access to a cluster
service.  We&#x27;ve already seen how to use NodePort to expose services to
the rest of the network, but there are better options.  Instead of having
each node just forward requests through to the appropriate pod, what
if we had an actual load balancer handling that?</p><p><a href="https://metallb.universe.tf/" target="_blank" rel="noopener noreferrer">MetalLB</a> is a load balancing controller
for bare-metal installations where you don&#x27;t have a cloud-native load
balancer to work with (such as AWS&#x27;s ELB).</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="preparing-kube-proxy"></a>Preparing kube-proxy<a aria-hidden="true" class="hash-link" href="#preparing-kube-proxy" title="Direct link to heading">#</a></h1><p>Before we can install MetalLB we need to make sure our <code>kube-proxy</code>
install has the required configuration, with strict ARP enabled and
running in IPVS mode.</p><p>I&#x27;m going to show you a couple of different ways you can handle making
this configuration change, to give you some ideas about ways you can
configure your cluster when you need to, you don&#x27;t need to do all of
them though.</p><p>First lets just check whether we already have the right settings or
not, by retrieving the kube-proxy ConfigMap and searching for the
settings we need.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-sh codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl get configmap kube-proxy -n kube-system -o yaml \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  | grep -E &#x27;(mode|strictARP)&#x27;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>That will return something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">strictARP: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">mode: &quot;&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Looks like we don&#x27;t have the right settings here.  One way we could
fix that is by using <code>kubectl edit configmap kube-proxy -n
kube-system</code> to open the ConfigMap in a text editor.  When you save
the file and exit the editor the changes will get applied to the
cluster.</p><p>Another common way of handling it is to retrieve the configmap, pipe
it through something like <code>sed</code> to make the changes, then pipe it back
into <code>kubectl apply</code>.  One useful feature of kubectl is that you can
use <code>diff</code> instead of <code>apply</code> to just see what changes would be made
without actually making them, then if the changes look good you can
switch back to apply to actually deploy them.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-sh codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl get configmap kube-proxy -n kube-system -o yaml \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  | sed -e &quot;s/strictARP: false/strictARP: true/&quot; -e &#x27;s/mode: &quot;&quot;/mode: ipvs/&#x27; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  | kubectl diff -f- -n kube-system</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>If all looks good then change <code>kubectl diff</code> to <code>kubectl apply</code> and
apply the configuration.</p><p>Since we&#x27;ve changed the kube-proxy configuration, we need to kill off
all the existing kube-proxy pods so that new ones will be built with
the new configuration.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-sh codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl get pods -n kube-system | awk &#x27;{print $1}&#x27; | grep kube-proxy \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  | xargs -n1 kubectl delete pod -n kube-system</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="installing-metallb"></a>Installing MetalLB<a aria-hidden="true" class="hash-link" href="#installing-metallb" title="Direct link to heading">#</a></h1><p>Installing the MetalLB manifests will setup both it&#x27;s controller (a
cluster-wide controller that handles IP address assignments) and
also a daemonset named &quot;speaker&quot; that is the component that speaks the
protocols of your choice to make services accessible.  This also
creates the necessary service accounts and RBAC permissions.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-sh codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.5/manifests/namespace.yaml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.5/manifests/metallb.yaml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>You also need to create a secret that will be used to encrypt
communication between the speakers that they use for fast dead node
detection.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-sh codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl create secret generic -n metallb-system memberlist --from-literal=secretkey=&quot;$(openssl rand -base64 128)&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>We&#x27;re going to configure MetalLB to use Layer 2 mode, because it&#x27;s the
simplest, and it&#x27;s all we need for Nginx Ingress.  All that we really
need to configure it is to provide a range of IP addresses that it can
use for creating load balancers.  These addresses don&#x27;t even need to
be bound to the network interfaces of your worker nodes, MetalLB will
respond to ARP requests on the local network directly, so you can just
pick a block of IPs from your local network that aren&#x27;t currently in
use by anything else (although you also need to ensure that your
router or DHCP server won&#x27;t try to assign these to any other systems).</p><p>To set this up we&#x27;re going to apply a <code>ConfigMap</code> into the namespace.
I&#x27;m going to use <code>192.168.1.240-192.168.1.249</code> as the LB IP&#x27;s:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-sh codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl apply -f- &lt;&lt;&#x27;END&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: ConfigMap</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  namespace: metallb-system</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: config</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">data:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  config: |</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    address-pools:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: default</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      protocol: layer2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      addresses:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - 192.168.1.240-192.168.1.249</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="configuring-loadbalancer-services"></a>Configuring LoadBalancer Services<a aria-hidden="true" class="hash-link" href="#configuring-loadbalancer-services" title="Direct link to heading">#</a></h1><p>Now that we have MetalLB configured, let&#x27;s add a LoadBalancer for our
Grafana application.  To do that we&#x27;ll just edit the service configuration
and change the type from <code>NodePort</code> to <code>LoadBalancer</code>:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-sh codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl edit service/grafana -n monitoring</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Once that is done you can describe it:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-sh codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl describe services grafana -n monitoring</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Which will produce some output that includes something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">LoadBalancer Ingress:     192.168.1.240</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Port:                     http  3000/TCP</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Which means you should be able to open a browser to
<a href="http://192.168.1.240:3000/" target="_blank" rel="noopener noreferrer">http://192.168.1.240:3000/</a> and see the Grafana login screen.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/jasonk/k8s-notes/edit/main/docs/setup/metallb.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/k8s-notes/setup/jsonnet-and-prometheus"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Jsonnet and Prometheus</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/k8s-notes/setup/nginx-ingress"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Nginx Ingress Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_ thin-scrollbar"></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="text--center"><div>Copyright Â© 2020 Jason Kohles</div></div></div></footer></div>
<script src="/k8s-notes/styles.69075ca6.js"></script>
<script src="/k8s-notes/runtime~main.583d16d4.js"></script>
<script src="/k8s-notes/main.8ee242e7.js"></script>
<script src="/k8s-notes/1.d74cfc91.js"></script>
<script src="/k8s-notes/25.575fc837.js"></script>
<script src="/k8s-notes/935f2afb.ead8358e.js"></script>
<script src="/k8s-notes/24.e6edf205.js"></script>
<script src="/k8s-notes/048d1949.98515b4e.js"></script>
</body>
</html>