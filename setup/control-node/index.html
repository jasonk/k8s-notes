<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.68">
<title data-react-helmet="true">Control Node | Jason&#x27;s Kubernetes Notes</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_language" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Control Node | Jason&#x27;s Kubernetes Notes"><meta data-react-helmet="true" name="description" content="To get our control node running, we first need to setup some things in"><meta data-react-helmet="true" property="og:description" content="To get our control node running, we first need to setup some things in"><meta data-react-helmet="true" property="og:url" content="https://jasonkohles.com/k8s-notes/setup/control-node"><link data-react-helmet="true" rel="shortcut icon" href="/k8s-notes/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://jasonkohles.com/k8s-notes/setup/control-node"><link rel="stylesheet" href="/k8s-notes/styles.e8739408.css">
<link rel="preload" href="/k8s-notes/styles.69075ca6.js" as="script">
<link rel="preload" href="/k8s-notes/runtime~main.a4215b58.js" as="script">
<link rel="preload" href="/k8s-notes/main.3878add6.js" as="script">
<link rel="preload" href="/k8s-notes/1.d74cfc91.js" as="script">
<link rel="preload" href="/k8s-notes/25.575fc837.js" as="script">
<link rel="preload" href="/k8s-notes/935f2afb.93050429.js" as="script">
<link rel="preload" href="/k8s-notes/24.e6edf205.js" as="script">
<link rel="preload" href="/k8s-notes/2a98a859.236928b6.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_2AhQ">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/k8s-notes/"><strong class="navbar__title">Jason&#x27;s Kubernetes Notes</strong></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/jasonk/k8s-notes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/k8s-notes/"><strong class="navbar__title">Jason&#x27;s Kubernetes Notes</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a href="https://github.com/jasonk/k8s-notes" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive thin-scrollbar menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">About</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/k8s-notes/">Welcome</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/k8s-notes/about/links">Helpful Kubernetes Links</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Setup</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/getting-started">Getting Started</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/k8s-notes/setup/control-node">Control Node</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/worker-nodes">Adding Worker Nodes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/user-config">User Configuration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/dashboard">Dashboard</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/helm">Helm</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/operators-and-openebs">Operators and OpenEBS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/jsonnet-and-prometheus">Jsonnet and Prometheus</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/metallb">MetalLB</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/nginx-ingress">Nginx Ingress</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/k8s-notes/setup/exploring-pods">Exploring Pods</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Concepts</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/k8s-notes/concepts/control-plane">Control Plane</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/k8s-notes/concepts/operators">Operators</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/k8s-notes/concepts/tainting">Taints and Tolerations</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Applications</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/k8s-notes/apps/argocd">ArgoCD</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/k8s-notes/apps/cert-manager">cert-manager</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_39qw"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Control Node</h1></header><div class="markdown"><p>To get our control node running, we first need to setup some things in
the base system.</p><p>The containerd runtime we&#x27;re going to use requires the <code>overlay</code> and
<code>br_netfilter</code> modules be loaded into the kernel.  We&#x27;re going to
create a <code>modules-load</code> entry to ensure they always get loaded on
boot, but then we can also just load them manually for now.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-sh codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">cat &lt;&lt;END &gt; /etc/modules-load.d/containerd.conf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">overlay</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">br_netfilter</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">modprobe overlay</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">modprobe br_netfilter</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>We also need to make sure that IP forwarding and some iptables
bridging options are enabled in sysctl.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-sh codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Setup required sysctl params, these persist across reboots.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cat &lt;&lt;END &gt; /etc/sysctl.d/99-kubernetes-cri.conf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">net.ipv4.ip_forward                 = 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">net.bridge.bridge-nf-call-iptables  = 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">net.bridge.bridge-nf-call-ip6tables = 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sysctl --system</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Now we&#x27;re going to start actually configuring things.  First we&#x27;ll
create a default configuration for <code>containerd</code>, which is easy because
it can create one for us.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-sh codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">mkdir -p /etc/containerd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">containerd config default &gt; /etc/containerd/config.toml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Next we&#x27;ll create our base kubelet configuration and enable kubelet to
start on boot.  You might want to substitute your own DNS server
settings in place of the ones in the file, but the ones here should
work if you don&#x27;t know what servers to use.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-sh codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">mkdir -p /var/lib/kubelet</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cat &lt;&lt;END &gt; /var/lib/kubelet/config.yaml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: kubelet.config.k8s.io/v1beta1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: KubeletConfiguration</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">clusterDns: [ 1.1.1.1, 8.8.8.8, 8.8.4.4 ]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl enable kubelet</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Next we need to configure systemd to pass the right options when it
starts containerd.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">KUBELET_ARGS=(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  --container-runtime=remote</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  --runtime-request-timeout=15m</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  --container-runtime-endpoint=unix:///run/containerd/containerd.sock</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">mkdir -p  /etc/systemd/system/kubelet.service.d/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cat &lt;&lt; END &gt; /etc/systemd/system/kubelet.service.d/0-containerd.conf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[Service]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Environment=&quot;KUBELET_EXTRA_ARGS=${KUBELET_ARGS[*]}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Now we&#x27;re ready to actually start up the cluster.  Start by using
<code>kubeadm</code> to pull down the images that it&#x27;s going to use, which will
save some time later, then you can initialize the cluster.  Make sure
to replace the values of the <code>control-plane-endpoint</code> and
<code>pod-network-cidr</code> options if you decided to use different values that
what we&#x27;re using.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-sh codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubeadm config images pull</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubeadm init --config=/var/lib/kubelet/config.yaml --upload-certs \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  --control-plane-endpoint=cluster.local</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  --pod-network-cidr=10.244.0.0/16 \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  --cri-socket /run/containerd/containerd.sock</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Your cluster should now be online.  If you are only going to have
a single node for now, or you just want to be able to run pods on your
control node, then you can remove the <code>master</code> taint from it.  This
&quot;taint&quot; is what normally keeps pods from being scheduled onto the
master node.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl taint nodes --all node-role.kubernetes.io/master-</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Note that when you run <code>kubeadm init</code> it will give you a command line
you can use to join other nodes to the cluster.  That process is
a little easier if you record that command somewhere safe, but I&#x27;ll
show you how to reproduce it if you need to also.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/jasonk/k8s-notes/edit/main/docs/setup/control-node.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/k8s-notes/setup/getting-started"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Getting Started</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/k8s-notes/setup/worker-nodes"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Adding Worker Nodes Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_ thin-scrollbar"></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="text--center"><div>Copyright Â© 2020 Jason Kohles</div></div></div></footer></div>
<script src="/k8s-notes/styles.69075ca6.js"></script>
<script src="/k8s-notes/runtime~main.a4215b58.js"></script>
<script src="/k8s-notes/main.3878add6.js"></script>
<script src="/k8s-notes/1.d74cfc91.js"></script>
<script src="/k8s-notes/25.575fc837.js"></script>
<script src="/k8s-notes/935f2afb.93050429.js"></script>
<script src="/k8s-notes/24.e6edf205.js"></script>
<script src="/k8s-notes/2a98a859.236928b6.js"></script>
</body>
</html>